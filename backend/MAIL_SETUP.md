# Настройка почты (mail.env) для VK SOSA

Инструкция по настройке отправки писем для **подтверждения email** (код из письма при регистрации и смене почты).

---

## 1. Файл конфигурации `mail.env`

- Создайте в папке `backend/` файл **`mail.env`** (скопируйте из `mail.env.example`).
- Файл **`mail.env`** добавлен в `.gitignore` и **не попадёт в репозиторий** — пароли остаются только у вас.

```bash
cd backend
cp mail.env.example mail.env
# Отредактируйте mail.env в любом редакторе
```

---

## 2. Переменные в `mail.env`

| Переменная | Обязательно | Описание |
|------------|-------------|----------|
| **SMTP_HOST** | Да | Адрес SMTP-сервера (например `smtp.gmail.com`). |
| **SMTP_PORT** | Нет (по умолчанию 587) | Порт: обычно **587** (TLS) или **465** (SSL). |
| **SMTP_USER** | Зависит от сервера | Логин (часто совпадает с email). |
| **SMTP_PASSWORD** | Зависит от сервера | Пароль от почты или **пароль приложения**. |
| **MAIL_FROM** | Нет | Адрес отправителя в письме. Если не указан — используется `SMTP_USER`. |
| **FRONTEND_VERIFY_EMAIL_URL** | Нет | Базовый URL сайта (например `https://your-site.com`). Используется в тексте письма, чтобы пользователь знал, куда вводить код. |
| **VERIFICATION_CODE_EXPIRE_MINUTES** | Нет (по умолчанию 15) | Время жизни кода подтверждения в минутах. |

Пример минимального `mail.env`:

```env
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=myapp@gmail.com
SMTP_PASSWORD=xxxx-xxxx-xxxx-xxxx
MAIL_FROM=myapp@gmail.com
FRONTEND_VERIFY_EMAIL_URL=https://vk-sosa.example.com
```

---

## 3. Настройка популярных почтовых сервисов

### Gmail

1. Включите **двухфакторную аутентификацию** в аккаунте Google.
2. Создайте **пароль приложения**: [Google Account → Безопасность → Пароли приложений](https://myaccount.google.com/apppasswords). Выберите «Почта» и «Другое устройство», скопируйте 16-символьный пароль.
3. В `mail.env` укажите:

```env
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=ваш-gmail@gmail.com
SMTP_PASSWORD=xxxx-xxxx-xxxx-xxxx
MAIL_FROM=ваш-gmail@gmail.com
```

- Порт **465** тоже поддерживается (SSL).

---

### Mail.ru

1. В настройках Mail.ru включите **доступ по IMAP/SMTP** (Настройки → Все настройки → Почтовые программы).
2. При необходимости создайте **пароль для внешнего приложения** (если включена 2FA).
3. В `mail.env`:

```env
SMTP_HOST=smtp.mail.ru
SMTP_PORT=587
SMTP_USER=ваш-логин@mail.ru
SMTP_PASSWORD=ваш-пароль-или-пароль-приложения
MAIL_FROM=ваш-логин@mail.ru
```

- Порт **465** (SSL) тоже можно использовать.

---

### Yandex

1. В [Яндекс ID](https://id.yandex.ru) включите **пароли приложений** (если включена 2FA) или используйте обычный пароль.
2. В `mail.env`:

```env
SMTP_HOST=smtp.yandex.ru
SMTP_PORT=587
SMTP_USER=ваш-логин@yandex.ru
SMTP_PASSWORD=ваш-пароль-или-пароль-приложения
MAIL_FROM=ваш-логин@yandex.ru
```

- Для корпоративной почты (@yandex-team.ru и т.п.) хост тот же: `smtp.yandex.ru`.

---

### Outlook / Microsoft 365

```env
SMTP_HOST=smtp.office365.com
SMTP_PORT=587
SMTP_USER=ваш-логин@outlook.com
SMTP_PASSWORD=ваш-пароль
MAIL_FROM=ваш-логин@outlook.com
```

---

### Свой SMTP-сервер (Postfix, Exim и т.д.)

Укажите хост и порт вашего сервера. Если авторизация не требуется, оставьте `SMTP_USER` и `SMTP_PASSWORD` пустыми (или не задавайте). Пример для локального сервера без логина:

```env
SMTP_HOST=localhost
SMTP_PORT=25
SMTP_USER=
SMTP_PASSWORD=
MAIL_FROM=noreply@your-domain.com
```

---

## 4. Проверка работы

1. Запустите бэкенд (после сохранения `mail.env`).
2. Зарегистрируйте нового пользователя с реальным email.
3. Проверьте папку «Входящие» и «Спам» — должно прийти письмо с темой **«Код подтверждения — VK SOSA»** и 6-значным кодом.
4. Введите код на странице `/verify-email` — после успешной проверки выполнится вход.

Если письмо не приходит:

- Проверьте логи бэкенда: при ошибке SMTP пишется предупреждение `Send verification email failed: ...`.
- Убедитесь, что `SMTP_HOST` и `SMTP_PORT` верные, а пароль не истёк (для Gmail — именно пароль приложения, не основной пароль).
- Для Gmail/Mail.ru/Yandex проверьте, что разрешён доступ для почтовых программ и при необходимости используйте пароль приложения.

---

## 5. Безопасность

- **Не коммитьте `mail.env`** в git — файл уже добавлен в `.gitignore`.
- Пароли храните только в `mail.env` или в переменных окружения на сервере.
- В продакшене предпочтительно задавать переменные через окружение (systemd, Docker, хостинг), а не через файл на диске.

---

## 6. Где используется почта в приложении

- **Регистрация** — после создания аккаунта на указанный email отправляется код; пользователь вводит его на странице подтверждения и автоматически входит.
- **Смена email** в настройках профиля — на новый адрес отправляется новый код.
- **Повторная отправка кода** — кнопка «Отправить повторно» на странице подтверждения или запрос к API (не чаще одного раза в 5 минут).

Файл-пример переменных: **`backend/mail.env.example`**.
